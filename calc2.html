<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calculadora de M√©dia GeralzonaV2</title>

  <style>
    :root{
      --azul:#004A7C;
      --verde:#49B04A;
      --fundo:#F7F9FB;
      --texto:#1A1A1A;
      --branco:#FFFFFF;
      --cinza:#777;
    }

    body{
      font-family: Poppins, Arial, sans-serif;
      background:var(--fundo);
      color:var(--texto);
      margin:0;
      padding:18px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:900px;
      margin:0 auto 14px;
    }

    .selectors{
      display:flex;
      gap:10px;
    }

    select{
      padding:10px 12px;
      border-radius:12px;
      border:2px solid var(--azul);
      background:#fff;
      outline:none;
    }

    .container{
      max-width:900px;
      margin:0 auto;
      background:var(--branco);
      border-radius:20px;
      box-shadow:0 8px 20px rgba(0,0,0,.08);
      padding:26px;
    }

    h1{
      margin:0 0 18px;
      color:var(--azul);
    }

    label{
      display:block;
      font-weight:600;
      color:var(--azul);
      margin:12px 0 6px;
    }

    input{
      width:90%;
      padding:10px;
      border:2px solid var(--azul);
      border-radius:12px;
      outline:none;
      font-size:1rem;
    }

    input:focus{ border-color:var(--verde); }

    .btn-main{
      background:var(--verde);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:12px 18px;
      font-size:1.05rem;
      margin-top:18px;
      cursor:pointer;
    }

    .btn-main:hover{ filter:brightness(.95); }

    .result{
      margin-top:18px;
      font-size:1.2rem;
      font-weight:700;
      color:var(--azul);
    }

    footer{
      margin-top:26px;
      font-size:.9rem;
      color:var(--azul);
      opacity:.85;
    }

    .btn-capsule{
      background:#c62828;
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
    }

    .btn-capsule.subtle{
      background:transparent;
      color:var(--azul);
      border:2px solid rgba(0,74,124,.25);
    }

    .btn-capsule.subtle:hover{
      border-color:rgba(0,74,124,.55);
    }

    .btn-capsule.gray{ background:#777; }

    .teacherbar{
      margin-top:18px;
      display:flex;
      gap:10px;
    }

    .hidden{ display:none; }

    /* MODAIS (discretos) */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.25);
      align-items:flex-start;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }

    .modal-box{
      background:#fff;
      padding:18px;
      border-radius:16px;
      width:320px;
      box-shadow:0 10px 24px rgba(0,0,0,.15);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-scroll {
      overflow-y: auto;
      flex: 1;                 /* ocupa o espa√ßo dispon√≠vel */
      margin: 12px 0;
      padding-right: 6px;      /* espa√ßo p/ scrollbar */
    }

    .modal-box.wide{
      width:min(860px, calc(100vw - 36px));
    }

    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:#444;
      opacity:.8;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .x{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:18px;
      opacity:.7;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 180px;
      gap:12px;
      margin-top:10px;
    }

    .items-head{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .items-desc{
      display: grid;
      margin-left: 10px;
      grid-template-columns: repeat(4,1fr) 50px;
    }

    .items{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .item-row{
      border:1px solid #ddd;
      border-radius:12px;
      padding:10px;
      display:grid;
      grid-template-columns:repeat(4,1fr) 50px;
      gap:10px;
      align-items:center;
    }

    .item-row input{
      border-width:1px;
      border-color:#ccc;
      width: 90%;
      padding:8px 10px;
      border-radius:10px;
    }

    .trash{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:18px;
    }

    /* ===== NOTIFY (modal de avisos) ===== */
    .notify--error #notifyTitle{ color:#c62828; }
    .notify--success #notifyTitle{ color:var(--verde); }
    .notify--warn #notifyTitle{ color:#f57c00; }
    .notify--info #notifyTitle{ color:var(--azul); }

    /* Deixa o texto do notify mais leg√≠vel */
    #notifyMsg{
      white-space: pre-wrap;
      line-height: 1.35;
      font-size: 13px;
      color:#222;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="selectors">
      <select id="selGrade">
        <option value="6o">6¬∫ ano</option>
        <option value="7o">7¬∫ ano</option>
        <option value="8o">8¬∫ ano</option>
        <option value="9o">9¬∫ ano</option>
      </select>

      <select id="selSubject">
        <option value="">Carregando...</option>
      </select>

      <select id="selPeriod">
        <option value="1">1¬∫ per√≠odo</option>
        <option value="2">2¬∫ per√≠odo</option>
        <option value="3">3¬∫ per√≠odo</option>
        <option value="4">4¬∫ per√≠odo</option>
      </select>
    </div>

    <button id="btnLogin" class="btn-capsule subtle">Professor</button>
  </div>

  <div class="container">
    <h1 id="calcTitle">Calculadora de M√©dia</h1>

    <div id="calcForm"></div>

    <button id="btnCalc" class="btn-main">Calcular M√©dia</button>
    <div id="resultado" class="result"></div>

    <div id="teacherBar" class="teacherbar hidden">
      <button id="btnEdit" class="btn-capsule">Editar calculadora</button>
      <button id="btnChangePass" class="btn-capsule">Trocar senha</button>
      <button id="btnGrabLink" class="btn-capsule gray">Copiar Link</button>
      <button id="btnLogout" class="btn-capsule gray">Sair</button>
    </div>

    <footer>
      ¬© 2026 Escola M√≥bile ‚Äî Ferramenta Educacional<br>
      gustavo.santucci@escolamobile.com.br
    </footer>
  </div>

  <!-- MODAL LOGIN -->
  <div id="loginModal" class="modal">
    <div class="modal-box">
      <h3>Login do professor</h3>
      <input id="loginUser" placeholder="Usu√°rio">
      <input id="loginPass" type="password" placeholder="Senha">
      <div class="modal-actions">
        <button class="btn-capsule" id="btnConfirmLogin">Entrar</button>
        <button class="btn-capsule gray" id="btnCancelLogin">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITOR -->
  <div id="editModal" class="modal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h3>Editar calculadora</h3>
        <button class="x" id="btnCloseEdit">‚úï</button>
      </div>

      <div class="grid2">
        <div>
          <label>T√≠tulo</label>
          <input id="editTitle" placeholder="Ex: Calculadora de M√©dia ‚Äî 1¬∫ Per√≠odo">
        </div>
        <div>
          <label>Escala final</label>
          <input id="editScale" type="number" step="1" min="1" value="10">
        </div>
      </div>

      <div class="items-head">
        <strong>Itens</strong>
        <button class="btn-capsule" id="btnAddItem">+ item</button>
      </div>

      <div class="items-desc">
        <strong>ID</strong>
        <strong>DESC</strong>
        <strong>NOTA M√ÅXIMA</strong>
        <strong>PESO</strong>
      </div>

      <div class="modal-scroll">
        <div id="itemsList" class="items"></div>
      </div>

      <div class="modal-actions">
        <button class="btn-capsule" id="btnSaveCalc">Salvar e publicar</button>
        <button class="btn-capsule gray" id="btnCancelEdit">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL TROCAR SENHA -->
  <div id="passModal" class="modal">
    <div class="modal-box">
      <h3>Trocar senha</h3>
      <input id="oldPass" type="password" placeholder="Senha atual">
      <input id="newPass" type="password" placeholder="Nova senha (m√≠n. 6)">
      <div class="modal-actions">
        <button class="btn-capsule" id="btnConfirmPass">Salvar</button>
        <button class="btn-capsule gray" id="btnCancelPass">Cancelar</button>
      </div>
      <div class="hint">
        Se voc√™ ainda est√° com <b>calc1234</b>, troque agora.
      </div>
    </div>
  </div>

  <!-- MODAL AVISO/ERRO (SUBSTITUI alert DO BROWSER) -->
  <div id="notifyModal" class="modal">
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="notifyTitle">Aviso</h3>
        <button class="x" id="btnCloseNotify">‚úï</button>
      </div>

      <div class="modal-scroll" style="margin-top:10px">
        <div id="notifyMsg"></div>
      </div>

      <div class="modal-actions">
        <button class="btn-capsule gray" id="btnOkNotify">OK</button>
      </div>
    </div>
  </div>

  <!-- IMPORTS + APP (MODULE) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    /* ====== CONFIG ====== */
    const SUPABASE_URL = 'https://msockegtgxnkrdmywcss.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_fuY9riiCPUOCdTu0rGLlMw_OSan8Ewr';
    const EDGE_FN_URL = `${SUPABASE_URL}/functions/v1/calc-admin`;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const selPeriod = document.getElementById('selPeriod');
    const btnChangePass = document.getElementById('btnChangePass');
    const passModal = document.getElementById('passModal');
    const oldPass = document.getElementById('oldPass');
    const newPass = document.getElementById('newPass');
    const btnConfirmPass = document.getElementById('btnConfirmPass');
    const btnCancelPass = document.getElementById('btnCancelPass');

    /* ====== STATE ====== */
    let calc = null; // { title, schema }
    let teacherToken = localStorage.getItem('teacherToken') || '';
    let teacherUser = localStorage.getItem('teacherUser') || '';

    /* ====== ELEMENTS ====== */
    const selGrade = document.getElementById('selGrade');
    const selSubject = document.getElementById('selSubject');
    const calcTitle = document.getElementById('calcTitle');
    const calcForm = document.getElementById('calcForm');
    const resultado = document.getElementById('resultado');

    const params = new URLSearchParams(window.location.search);
    const lockedGrade = params.get("grade");    // ex: "9o"
    const lockedSubject = params.get("subject");// ex: "mat"

    const btnLogin = document.getElementById('btnLogin');
    const teacherBar = document.getElementById('teacherBar');
    const btnEdit = document.getElementById('btnEdit');
    const btnLogout = document.getElementById('btnLogout');

    const loginModal = document.getElementById('loginModal');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const btnConfirmLogin = document.getElementById('btnConfirmLogin');
    const btnCancelLogin = document.getElementById('btnCancelLogin');

    const editModal = document.getElementById('editModal');
    const btnGrabLink = document.getElementById('btnGrabLink');
    const btnCloseEdit = document.getElementById('btnCloseEdit');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSaveCalc = document.getElementById('btnSaveCalc');
    const btnAddItem = document.getElementById('btnAddItem');
    const editTitle = document.getElementById('editTitle');
    const editScale = document.getElementById('editScale');
    const itemsList = document.getElementById('itemsList');

    document.getElementById('btnCalc').addEventListener('click', calcularMedia);

    let teacherPerms = null; // [{grade:'9o', subject:'mat'}, ...]

    /* ====== UI HELPERS ====== */
    function openModal(el) {
      el.style.display = 'flex';
    }
    function closeModal(el) {
      el.style.display = 'none';
    }

    /* ====== NOTIFY MODAL (substitui alert) ====== */
    const notifyModal = document.getElementById("notifyModal");
    const notifyTitle = document.getElementById("notifyTitle");
    const notifyMsg = document.getElementById("notifyMsg");
    const btnCloseNotify = document.getElementById("btnCloseNotify");
    const btnOkNotify = document.getElementById("btnOkNotify");

    function notify(message, type = "warn", title) {
      notifyModal.classList.remove("notify--error","notify--success","notify--warn","notify--info");
      notifyModal.classList.add(`notify--${type}`);

      notifyTitle.textContent =
        title || (type === "error" ? "Erro" : type === "success" ? "Sucesso" : type === "info" ? "Info" : "Aviso");

      notifyMsg.textContent = String(message ?? "");
      openModal(notifyModal);
      setTimeout(() => btnOkNotify?.focus(), 0);
    }

    function closeNotify(){ closeModal(notifyModal); }
    btnCloseNotify.addEventListener("click", closeNotify);
    btnOkNotify.addEventListener("click", closeNotify);

    // Fecha no ESC
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && notifyModal.style.display === "flex") closeNotify();
    });

    // Intercepta QUALQUER alert() do browser
    window.alert = (msg) => notify(msg, "warn", "Aviso");

    function setTeacherMode(on) {
      teacherBar.classList.toggle("hidden", !on);
      btnLogin.textContent = on ? `Professor: ${teacherUser}` : "Professor";

      if (btnChangePass) {
        btnChangePass.style.display = on ? "inline-block" : "none";
      }
    }

    async function loadTeacherPermissions() {
      if (!teacherToken) return null;

      const r = await fetch(EDGE_FN_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${teacherToken}`,
        },
        body: JSON.stringify({ action: "list_permissions" }),
      });

      const raw = await r.text();
      let j = {};
      try { j = JSON.parse(raw); } catch {}

      if (!r.ok) {
        console.log("list_permissions FAIL:", r.status, raw);
        return null;
      }
      return j.permissions || [];
    }

    function populateGradeSelectFromPerms(perms) {
      const grades = [...new Set(perms.map(p => p.grade))].sort();
      selGrade.innerHTML = grades.map(g => `<option value="${g}">${g.toUpperCase()}</option>`).join("");
    }

    async function populateSubjectSelectForGradeFromPerms(grade, perms) {
      const allowedSubjects = new Set(perms.filter(p => p.grade === grade).map(p => p.subject));

      const { data, error } = await supabase
        .from("subjects")
        .select("code,name,sort")
        .eq("grade", grade)
        .eq("active", true)
        .order("sort", { ascending: true });

      if (error || !data) {
        selSubject.innerHTML = [...allowedSubjects].map(s => `<option value="${s}">${s.toUpperCase()}</option>`).join("");
        return;
      }

      const filtered = data.filter(s => allowedSubjects.has(s.code));
      selSubject.innerHTML = filtered.map(s => `<option value="${s.code}">${s.name}</option>`).join("");

      const already = new Set(filtered.map(x => x.code));
      [...allowedSubjects].forEach(code => {
        if (!already.has(code)) {
          selSubject.insertAdjacentHTML("beforeend", `<option value="${code}">${code.toUpperCase()}</option>`);
        }
      });
    }

    async function loadSubjectsForGrade() {
      const grade = selGrade.value;

      const { data, error } = await supabase
        .from('subjects')
        .select('code, name, sort')
        .eq('grade', grade)
        .order('sort', { ascending: true });

      if (error || !data?.length) {
        selSubject.innerHTML = `<option value="">Sem disciplinas</option>`;
        return;
      }

      const current = selSubject.value;
      selSubject.innerHTML = data
        .map((s) => `<option value="${s.code}">${s.name}</option>`)
        .join('');

      if (current && data.some((s) => s.code === current)) {
        selSubject.value = current;
      }
    }

    window.addEventListener("message", async (ev) => {
      const msg = ev.data;
      if (!msg || msg.type !== "SET_CONTEXT") return;

      if (msg.grade) selGrade.value = msg.grade;
      await loadSubjectsForGrade();

      if (msg.subject) selSubject.value = msg.subject;

      selGrade.disabled = true;
      selSubject.disabled = true;
      selGrade.style.opacity = "0.65";
      selSubject.style.opacity = "0.65";

      await loadCalculator();
    });

    function applyLockUI() {
      const lockOn = !!(lockedGrade && lockedSubject);

      if (lockOn) {
        selGrade.value = lockedGrade;
        selGrade.disabled = true;
        selGrade.style.opacity = "0.65";

        selSubject.disabled = true;
        selSubject.style.opacity = "0.65";
      } else {
        selGrade.disabled = false;
        selGrade.style.opacity = "1";
        selSubject.disabled = false;
        selSubject.style.opacity = "1";
      }
    }

    /* ====== LOGIN / LOGOUT ====== */
    btnLogin.addEventListener('click', () => {
      openModal(loginModal);
      setTimeout(() => loginUser.focus(), 50);
    });

    btnCancelLogin.addEventListener('click', () => closeModal(loginModal));

    btnConfirmLogin.addEventListener('click', async () => {
      const u = loginUser.value.trim();
      const p = loginPass.value;

      if (!u || !p) {
        notify('Preencha usu√°rio e senha.', "warn");
        return;
      }

      const r = await fetch(EDGE_FN_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'login', username: u, password: p }),
      });

      const raw = await r.text();
      let j = {};
      try { j = JSON.parse(raw); } catch {}

      if (!r.ok) {
        notify(
          `HTTP ${r.status}\n` +
          `RAW:\n${raw.slice(0, 600)}\n\n` +
          `JSON.error: ${j.error || '(sem)'}\n` +
          `JSON.detail: ${j.detail || '(sem)'}`,
          "error",
          "Falha no login"
        );
        return;
      }

      teacherToken = j.token;
      teacherUser = j.username;
      localStorage.setItem('teacherToken', teacherToken);
      localStorage.setItem('teacherUser', teacherUser);

      closeModal(loginModal);
      setTeacherMode(true);

      // Se tiver permiss√£o, ajusta selects (opcional)
      try{
        teacherPerms = await loadTeacherPermissions();
        if (teacherPerms?.length) {
          populateGradeSelectFromPerms(teacherPerms);
          await populateSubjectSelectForGradeFromPerms(selGrade.value, teacherPerms);
          await loadCalculator();
        }
      }catch(e){
        console.log(e);
      }
    });

btnLogout.addEventListener('click', async () => {
  // limpa sess√£o professor
  teacherToken = '';
  teacherUser = '';
  teacherPerms = null;

  localStorage.removeItem('teacherToken');
  localStorage.removeItem('teacherUser');

  setTeacherMode(false);

  // ===== VOLTA PARA MODO ALUNO ‚ÄúNORMAL‚Äù =====
  // restaura op√ß√µes padr√£o de ano
  selGrade.innerHTML = `
    <option value="6o">6¬∫ ano</option>
    <option value="7o">7¬∫ ano</option>
    <option value="8o">8¬∫ ano</option>
    <option value="9o">9¬∫ ano</option>
  `;

  // se N√ÉO for modo travado por link, destrava selects
  const isLocked = !!(lockedGrade && lockedSubject);

  if (!isLocked) {
    selGrade.disabled = false;
    selSubject.disabled = false;
    selGrade.style.opacity = "1";
    selSubject.style.opacity = "1";

    // recarrega disciplinas normalmente (sem filtro de permiss√£o)
    await loadSubjectsForGrade();
  } else {
    // se for link travado, mant√©m travado e re-seleciona os valores do link
    selGrade.value = lockedGrade;
    await loadSubjectsForGrade();
    selSubject.value = lockedSubject;

    selGrade.disabled = true;
    selSubject.disabled = true;
    selGrade.style.opacity = "0.65";
    selSubject.style.opacity = "0.65";
  }

  // recarrega a calculadora no contexto atual
  await loadCalculator();
});


    /* ====== TROCAR SENHA ====== */
    btnChangePass.addEventListener("click", () => {
      if (!teacherToken) {
        notify("Fa√ßa login como professor para trocar a senha.", "warn");
        return;
      }
      oldPass.value = "";
      newPass.value = "";
      openModal(passModal);
      setTimeout(() => oldPass.focus(), 50);
    });

    btnCancelPass.addEventListener("click", () => closeModal(passModal));

    btnConfirmPass.addEventListener("click", async () => {
      if (!teacherToken) {
        openModal(loginModal);
        return;
      }

      const old_password = oldPass.value;
      const new_password = newPass.value;

      if (!old_password || !new_password) {
        notify("Preencha os dois campos.", "warn");
        return;
      }
      if (new_password.length < 6) {
        notify("A nova senha precisa ter pelo menos 6 caracteres.", "warn");
        return;
      }

      const r = await fetch(EDGE_FN_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${teacherToken}`
        },
        body: JSON.stringify({ action: "change_password", old_password, new_password })
      });

      const raw = await r.text();
      let j = {};
      try { j = JSON.parse(raw); } catch {}

      if (!r.ok) {
        const msg =
          j.error === "invalid_old_password" ? "Senha atual incorreta." :
          j.error === "weak_password" ? "Senha nova fraca." :
          (j.detail || j.error || raw || "Erro ao trocar senha.");
        notify(msg, "error", "Falha ao trocar senha");
        return;
      }

      closeModal(passModal);
      notify("Senha alterada com sucesso!", "success");
    });

    /* ====== LINK ====== */
    btnGrabLink.addEventListener('click', copyDisciplineLink);

    /* ====== EDITOR ====== */
    btnEdit.addEventListener('click', () => {
      if (!calc) return;

      editTitle.value = calc.title || '';
      editScale.value = calc.schema?.scale ?? 10;

      renderEditorItems(calc.schema?.items || []);
      openModal(editModal);
    });

    btnCloseEdit.addEventListener('click', () => closeModal(editModal));
    btnCancelEdit.addEventListener('click', () => closeModal(editModal));

    /* ====== LOAD CALCULATOR ====== */
    async function loadCalculator() {
      const grade = selGrade.value;
      const subject = selSubject.value;
      const period = Number(selPeriod.value);

      if (!subject) {
        calcTitle.textContent = 'Selecione uma disciplina';
        calcForm.innerHTML = '';
        resultado.textContent = '';
        return;
      }

      const { data, error } = await supabase
        .from('calculators')
        .select('title, schema')
        .eq('grade', grade)
        .eq('subject', subject)
        .eq('period', period)
        .eq('published', true)
        .maybeSingle();

      if (error) {
        calcTitle.textContent = 'Erro ao carregar calculadora';
        calcForm.innerHTML = '';
        return;
      }

      if (!data) {
        calc = {
          title: `C√°lculo de M√©dia ‚Äî ${grade.toUpperCase()} / ${subject.toUpperCase()} / ${period}¬∫`,
          schema: { scale: 10, items: [] },
        };
        calcTitle.textContent = calc.title;
        calcForm.innerHTML = `<div style="opacity:.8">Nenhuma calculadora publicada para este per√≠odo.</div>`;
        resultado.textContent = '';
        return;
      }

      calc = data;
      calcTitle.textContent = data.title;
      renderForm(data.schema);
      resultado.textContent = '';
    }

    selGrade.addEventListener("change", async () => {
      if (teacherToken && teacherPerms?.length) {
        await populateSubjectSelectForGradeFromPerms(selGrade.value, teacherPerms);
        await loadCalculator();
      } else {
        await loadSubjectsForGrade();
        await loadCalculator();
      }
    });

    selSubject.addEventListener('change', loadCalculator);
    selPeriod.addEventListener('change', loadCalculator);

    /* ====== RENDER FORM ====== */
    function renderForm(schema) {
      const items = schema?.items || [];
      calcForm.innerHTML = '';

      items.forEach((it) => {
        const label = document.createElement('label');
        label.setAttribute('for', it.id);
        label.textContent = it.label;

        const input = document.createElement('input');
        input.type = 'number';
        input.id = it.id;
        input.step = '0.05';
        input.min = '0';
        input.max = String(it.max ?? 10);
        input.placeholder = `Digite a nota (m√°x ${it.max})`;
        input.addEventListener('input', () => limitarNota(input));

        calcForm.appendChild(label);
        calcForm.appendChild(input);
      });
    }

    function limitarNota(input) {
      const max = parseFloat(input.max);
      const min = 0;
      const v = parseFloat(input.value);
      if (Number.isNaN(v)) return;
      if (v > max) input.value = String(max);
      if (v < min) input.value = String(min);
    }

    /* ====== CALC ====== */
    function calcularMedia() {
      if (!calc?.schema?.items?.length) {
        resultado.style.color = 'red';
        resultado.textContent = 'Sem itens para calcular.';
        return;
      }

      const schema = calc.schema;
      const items = schema.items;
      const scale = schema.scale ?? 10;

      let sumW = 0;
      let sum = 0;

      for (const it of items) {
        const el = document.getElementById(it.id);
        const v = parseFloat(el.value);
        if (Number.isNaN(v)) {
          resultado.style.color = 'red';
          resultado.textContent = 'Por favor, preencha todas as notas.';
          return;
        }
        const max = Number(it.max ?? 10);
        const w = Number(it.weight ?? 0);

        sumW += w;
        sum += (max > 0 ? v / max : 0) * w;
      }

      const media = sumW > 0 ? (sum / sumW) * scale : 0;

      resultado.style.color = media >= 6 ? 'var(--verde)' : 'red';
      resultado.textContent = `M√©dia: ${media.toFixed(1)}`;
    }

    /* ====== EDITOR ====== */
    function renderEditorItems(items) {
      itemsList.innerHTML = '';
      items.forEach((it, idx) => itemsList.appendChild(editorRow(it, idx)));
    }

    function editorRow(it, idx) {
      const row = document.createElement('div');
      row.className = 'item-row';

      const id = document.createElement('input');
      id.value = it.id ?? '';
      id.placeholder = 'id (ex: S14)';

      const label = document.createElement('input');
      label.value = it.label ?? '';
      label.placeholder = 'Descri√ß√£o do item';

      const max = document.createElement('input');
      max.type = 'number';
      max.step = '0.05';
      max.value = String(it.max ?? 10);
      max.placeholder = 'm√°x';

      const weight = document.createElement('input');
      weight.type = 'number';
      weight.step = '0.05';
      weight.value = String(it.weight ?? 0);
      weight.placeholder = 'peso (ex: 0.02)';

      const trash = document.createElement('button');
      trash.className = 'trash';
      trash.textContent = 'üóë';
      trash.onclick = () => row.remove();

      row.appendChild(id);
      row.appendChild(label);
      row.appendChild(max);
      row.appendChild(weight);
      row.appendChild(trash);

      return row;
    }

    btnAddItem.addEventListener('click', () => {
      itemsList.appendChild(
        editorRow({ id: '', label: '', max: 10, weight: 0 }, 999),
      );
    });

    btnSaveCalc.addEventListener('click', async () => {
      if (!teacherToken) {
        notify('Voc√™ precisa estar logado como professor.', "warn");
        return;
      }

      const grade = selGrade.value;
      const subject = selSubject.value;

      const items = [...itemsList.querySelectorAll('.item-row')].map((r) => {
        const inputs = r.querySelectorAll('input');
        return {
          id: inputs[0].value.trim(),
          label: inputs[1].value.trim(),
          max: Number(inputs[2].value),
          weight: Number(inputs[3].value),
        };
      });

      if (items.some((i) => !i.id || !i.label || !(i.max > 0))) {
        notify('Revise: todo item precisa de id, descri√ß√£o e m√°ximo > 0.', "warn");
        return;
      }

      const payload = {
        action: "upsert_calculator",
        grade,
        subject,
        period: Number(selPeriod.value),
        title: editTitle.value.trim() || `Calculadora ‚Äî ${grade}/${subject}/${selPeriod.value}¬∫`,
        schema: {
          scale: Number(editScale.value) || 10,
          items
        }
      };

      const r = await fetch(EDGE_FN_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${teacherToken}`,
        },
        body: JSON.stringify(payload),
      });

      const raw = await r.text();
      console.log("RAW RESPONSE:", raw);

      let j = {};
      try { j = JSON.parse(raw); } catch {}

      if (!r.ok) {
        notify(
          "Erro ao salvar:\n" + (j.detail || j.error || raw || "desconhecido"),
          "error",
          "Falha ao salvar"
        );
        return;
      }

      closeModal(editModal);
      await loadCalculator();
      notify('Calculadora publicada!', "success");
    });

    function copyDisciplineLink() {
      const grade = selGrade.value;
      const subject = selSubject.value;

      if (!grade || !subject) {
        notify('Selecione ano e disciplina antes de copiar o link.', "warn");
        return;
      }

      const url = new URL(window.location.href);
      url.searchParams.set("grade", grade);
      url.searchParams.set("subject", subject);

      navigator.clipboard.writeText(url.toString())
        .then(() => notify("Link copiado! Compartilhe com os alunos.", "success"))
        .catch(() => notify("N√£o foi poss√≠vel copiar. Copie manualmente.", "warn"));
    }

    /* ====== INIT ====== */
    setTeacherMode(!!teacherToken);
    applyLockUI();
    await loadSubjectsForGrade();

    // se a p√°gina est√° ‚Äútravada‚Äù por link (grade+subject), tenta selecionar subject ap√≥s carregar
    if (lockedGrade && lockedSubject) {
      selGrade.value = lockedGrade;
      await loadSubjectsForGrade();
      selSubject.value = lockedSubject;
      selSubject.disabled = true;
      selSubject.style.opacity = "0.65";
    }

    await loadCalculator();

    // atalhos Enter no login
    loginUser.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btnConfirmLogin.click();
    });
    loginPass.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btnConfirmLogin.click();
    });

    // Erros globais (sem alert do browser)
    window.addEventListener("unhandledrejection", e => {
      const reason = e?.reason?.message || e?.reason || "Erro desconhecido (Promise)";
      notify("ERRO JS (Promise): " + reason, "error");
      console.error(e.reason);
    });

    window.addEventListener("error", e => {
      notify("ERRO JS: " + (e?.message || "Erro desconhecido"), "error");
      console.error(e);
    });
  </script>
</body>
</html>
